<script>
  // Read ?state= from URL (e.g., /resources/state.html?state=florida)
  const urlParams = new URLSearchParams(window.location.search);
  const stateKey = urlParams.get('state')?.toLowerCase().replace(/\s+/g, '_');

  const titleEl = document.getElementById('state-title');
  const container = document.getElementById('resources-container');

  function section(title, items, asLinks = true) {
    if (!items || !items.length) return '';
    let html = `<div class="section-title"><h2>${title}</h2><ul>`;
    for (const it of items) {
      html += asLinks
        ? `<li><a href="${it.url}" target="_blank" rel="noopener">${it.label}</a></li>`
        : `<li>${typeof it === 'string' ? it : `${it.label ?? ''} ${it.value ? 'â€” ' + it.value : ''} ${it.note ? `<span class="muted">(${it.note})</span>` : ''}`}</li>`;
    }
    html += `</ul></div>`;
    return html;
  }

  async function load() {
    if (!stateKey) {
      titleEl.textContent = 'No state selected';
      return;
    }

    // Cache-bust the JSON to avoid stale loads on CDNs
    const url = `/assets/states.json?v=${Date.now()}`;

    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (!data[stateKey]) {
        titleEl.textContent = 'State not found';
        return;
      }

      // Optional per-state background image: assets/State/Dad-<StateNameNoSpaces>.PNG
      const imgName = data[stateKey].name?.replace(/\s+/g, '') || '';
      document.body.style.backgroundImage = `url('/assets/State/Dad-${imgName}.PNG')`;
      document.body.style.backgroundSize = 'cover';
      document.body.style.backgroundRepeat = 'no-repeat';
      document.body.style.backgroundAttachment = 'fixed';
      document.body.style.backgroundPosition = 'center';
      document.body.style.backgroundColor = 'rgba(14,17,23,0.8)';
      document.body.style.backgroundBlendMode = 'overlay';

      const stateData = data[stateKey];
      titleEl.textContent = `${stateData.name} Resources`;

      // NATIONWIDE box
      let nat = '';
      nat += section('Agencies & Help Centers', data.national.agencies);
      nat += section('Forms & Templates', data.national.forms);
      nat += section('Statutes & Laws', data.national.statutes, false);
      if (data.national.notes) {
        nat += `<div class="section-title"><h2>Notes</h2><p>${data.national.notes}</p></div>`;
      }

      // STATE box (includes infobox if present)
      let st = '';
      st += section('Agencies & Help Centers', stateData.agencies);
      st += section('Forms & Templates', stateData.forms);
      st += section('Statutes & Laws', stateData.statutes, false);
      if (stateData.notes) {
        st += `<div class="section-title"><h2>Notes</h2><p>${stateData.notes}</p></div>`;
      }
      if (stateData.infobox) {
        const ib = stateData.infobox;
        st += `
          <div class="section-title">
            <h2>${ib.title || 'At a Glance'}</h2>
            ${ib.factors?.length ? `<h3 class="muted">${ib.factors_title || 'Key Factors'}</h3><ul>${
              ib.factors.map(f => `<li>${f}</li>`).join('')
            }</ul>` : ''}
            ${ib.stats?.length ? `<h3 class="muted">${ib.stats_title || 'Trends'}</h3><ul>${
              ib.stats.map(s => `<li><strong>${s.label}:</strong> ${s.value}${s.note ? ` <span class="muted">(${s.note})</span>` : ''}</li>`).join('')
            }</ul>` : ''}
            ${ib.disclaimer ? `<p class="muted">${ib.disclaimer}</p>` : ''}
          </div>`;
      }

      container.innerHTML = `
        <div class="panel"><h2>Nationwide Resources</h2>${nat || '<p class="muted">None yet.</p>'}</div>
        <div class="panel"><h2>State Resources</h2>${st || '<p class="muted">None yet.</p>'}</div>
      `;
    } catch (err) {
      titleEl.textContent = 'Error loading resources';
      // Show the error on-page to help debug
      container.innerHTML = `<div class="panel"><pre class="muted" style="white-space:pre-wrap">Load error: ${err.message}</pre></div>`;
      console.error('states.json load error:', err);
    }
  }

  load();
</script>
